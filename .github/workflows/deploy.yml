name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SERVER_SSH_KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}

    - name: Deploy to DigitalOcean
      env:
        HOST: ${{ secrets.HOST }}
        USERNAME: ${{ secrets.USERNAME }}
      run: |
        ssh $USERNAME@$HOST << EOF
          # Navigate to your project directory
          cd /root/Info
          echo "Current directory: $(pwd)"
          
          # Pull the latest changes
          git pull origin main

          # Set up and use Python virtual environment
          python3 -m venv venv
          source venv/bin/activate

          # Install backend dependencies
          cd BE
          pip install -r requirements.txt
          pip install flask gunicorn
          cd ..

          # Navigate to the src directory
          cd src
          echo "Current directory before npm build: $(pwd)"

          # Install frontend dependencies and build
          npm install
          npm run build

          # Debug: List contents of current directory and parent directory
          echo "Contents of src directory:"
          ls -la
          echo "Contents of parent directory:"
          ls -la ..

          # Navigate back to the project root
          cd ..
          echo "Current directory after build: $(pwd)"

          # Check if build directory exists and is not empty
          if [ -d "build" ]; then
            echo "Build directory exists"
            echo "Contents of build directory:"
            ls -la build
            if [ "$(ls -A build)" ]; then
              # Copy built frontend assets to the Nginx root directory
              sudo cp -r build/* /var/www/myapp/
              echo "Frontend files copied successfully"
            else
              echo "Build directory is empty"
              exit 1
            fi
          else
            echo "Build directory is missing in project root"
            exit 1
          fi

          # Set up Gunicorn service if it doesn't exist
          if [ ! -f "/etc/systemd/system/gunicorn.service" ]; then
            sudo tee /etc/systemd/system/gunicorn.service > /dev/null <<EOT
          [Unit]
          Description=Gunicorn instance to serve your Flask application
          After=network.target

          [Service]
          User=root
          WorkingDirectory=/root/Info/BE
          ExecStart=/root/Info/venv/bin/gunicorn --workers 3 --bind unix:app.sock -m 007 app:app

          [Install]
          WantedBy=multi-user.target
          EOT
            sudo systemctl daemon-reload
          fi

          # Restart Gunicorn
          sudo systemctl restart gunicorn

          # Restart Nginx
          sudo systemctl restart nginx

          # Check services status
          echo "Checking Gunicorn status:"
          sudo systemctl status gunicorn
          
          echo "Checking Nginx status:"
          sudo systemctl status nginx

          echo "Deployment completed. Gunicorn and Nginx restarted."

          # Display recent log entries
          echo "Recent Nginx error log entries:"
          sudo tail -n 20 /var/log/nginx/error.log

          echo "Recent API error log entries:"
          sudo tail -n 20 /var/log/nginx/api_error.log

          # List files in the deployment directory
          echo "Files in /var/www/myapp:"
          ls -l /var/www/myapp/
        EOF